<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Account Deletion Request — Debug Friendly</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#f8fafc; margin:0; padding:24px}
  .card{max-width:720px;margin:36px auto;background:#fff;padding:28px;border-radius:12px;box-shadow:0 6px 30px rgba(2,6,23,0.06)}
  h1{font-size:22px;margin:0 0 8px}
  p.lead{color:#374151;margin:0 0 18px}
  label{font-weight:600;color:#111827;margin-top:8px;display:block}
  textarea{width:100%;min-height:110px;padding:10px;border:1px solid #e5e7eb;border-radius:8px;outline:none}
  button{background:#2563eb;color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
  button[disabled]{opacity:.6;cursor:default}
  .info{background:#eef2ff;color:#1e3a8a;padding:10px;border-radius:8px;margin-bottom:12px}
  .success{background:#ecfdf5;color:#065f46;padding:10px;border-radius:8px;display:none}
  .error{background:#fff1f2;color:#991b1b;border:1px solid #fecaca;padding:10px;border-radius:8px;display:none}
  pre{background:#0f172a;color:#fff;padding:10px;border-radius:8px;overflow:auto;white-space:pre-wrap}
  a.link{color:#2563eb}
  .small{font-size:13px;color:#6b7280}
</style>
</head>
<body>
  <div class="card">
    <h1>Account Deletion Request</h1>
    <p class="lead">Only signed-in users can submit. This page shows detailed error info to help debugging.</p>

    <div id="devWarnings" class="info" style="display:none"></div>

    <div id="userInfo" class="info">Checking auth...</div>

    <form id="deleteForm" style="display:none">
      <label for="reason">Reason (optional)</label>
      <textarea id="reason" placeholder="Optional — tell us why..."></textarea>
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <button id="submitBtn" type="submit">Submit Deletion Request</button>
        <span id="loadingText" class="small" style="display:none">Submitting…</span>
      </div>
    </form>

    <div id="success" class="success">✅ Request submitted successfully.</div>
    <div id="errorBox" class="error" role="alert" style="display:none">
      <div id="errorFriendly"></div>
      <details style="margin-top:8px"><summary class="small">Show full error details</summary>
        <pre id="errorDetails"></pre>
      </details>
    </div>

    <p class="small" style="margin-top:14px">Developer tips: Open Console (F12) → check FirebaseError code if the friendly message is unclear.</p>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // ---------- REPLACE WITH YOUR FIREBASE CONFIG ----------
 const firebaseConfig = {
    apiKey: "AIzaSyDHRDRRm2KBmCuUf3qvTIRI5hO0aXFFx3w",
    authDomain: "asprients-95c1f.firebaseapp.com",
    projectId: "asprients-95c1f",
    storageBucket: "asprients-95c1f.appspot.com",
    messagingSenderId: "453218332819",
    appId: "1:453218332819:web:5740173fa4d8156dae9d66"
};

  // -------------------------------------------------------

  const devWarnings = document.getElementById('devWarnings');
  const userInfo = document.getElementById('userInfo');
  const form = document.getElementById('deleteForm');
  const submitBtn = document.getElementById('submitBtn');
  const loadingText = document.getElementById('loadingText');
  const successBox = document.getElementById('success');
  const errorBox = document.getElementById('errorBox');
  const errorFriendly = document.getElementById('errorFriendly');
  const errorDetails = document.getElementById('errorDetails');

  // small validation: confirm config replaced
  function configLooksValid(cfg){
    return cfg && !Object.values(cfg).some(v => typeof v !== 'string' || v.includes('YOUR_'));
  }
  if (!configLooksValid(firebaseConfig)) {
    devWarnings.style.display = 'block';
    devWarnings.innerHTML = "<strong>Firebase config not replaced.</strong><br>Replace the placeholders in firebaseConfig with your real project values.";
  }

  // warn for file:// usage
  if (location.protocol === 'file:') {
    devWarnings.style.display = 'block';
    devWarnings.innerHTML += "<br><strong>Serving from file://</strong> — serve via http (e.g., Live Server) to avoid origin issues.";
  }

  // init firebase (still safe to initialize with placeholders; but we validated above)
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // map of friendly messages for common firebase error codes
  const friendlyMap = {
    "permission-denied": "Write blocked by Firestore security rules. Check and update rules to permit authenticated users to create deletion requests.",
    "unauthenticated": "You are not authenticated. Make sure you are signed in and the app's auth domain is authorized in Firebase Console.",
    "network-request-failed": "Network error — check your internet connection.",
    "quota-exceeded": "Firestore quota exceeded — check Firebase Console billing & usage.",
    "invalid-argument": "Some field value is invalid. Check the data being sent.",
    "not-found": "Resource not found. Verify Firestore is enabled and collection path is correct.",
    "internal": "Internal server error — try again later."
  };

  function showError(err){
    console.error("Firestore error:", err);
    errorBox.style.display = 'block';
    const code = err && err.code ? err.code.replace('auth/', '').replace('permission-denied','permission-denied') : 'unknown';
    const friendly = friendlyMap[code] || "An unexpected error occurred. See details below.";
    errorFriendly.textContent = `${friendly} (code: ${err.code || 'unknown'})`;
    errorDetails.textContent = err && err.message ? err.message : JSON.stringify(err);
    // hide success if visible
    successBox.style.display = 'none';
  }

  function clearMessages(){
    errorBox.style.display = 'none';
    successBox.style.display = 'none';
    errorFriendly.textContent = '';
    errorDetails.textContent = '';
  }

  // Auth state handling
  onAuthStateChanged(auth, (user) => {
    clearMessages();
    if (user) {
      const name = user.displayName || "Unknown";
      const email = user.email || "No email";
      userInfo.innerHTML = `<strong>Signed in as:</strong> ${name} (${email})`;
      form.style.display = 'block';
    } else {
      userInfo.innerHTML = `⚠️ You must be signed-in to submit a deletion request. <a href="index.html" class="link">Go to login</a>`;
      form.style.display = 'none';
    }
  });

  // submit handler
  form.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    clearMessages();

    const user = auth.currentUser;
    if (!user) {
      showError({ code: 'unauthenticated', message: 'No current user (auth.currentUser is null).' });
      return;
    }

    // extra config validation (helpful)
    if (!configLooksValid(firebaseConfig)) {
      showError({ code: 'invalid-config', message: 'Please replace Firebase config placeholders in the page.' });
      return;
    }

    // disable UI while submitting
    submitBtn.disabled = true;
    loadingText.style.display = 'inline';
    const reason = document.getElementById('reason').value.trim();

    try {
      // Add doc
      await addDoc(collection(db, "account_deletion_requests"), {
        name: fullname|| null,
        email: user.email || null,
        reason,
        userId: user.uid,
        timestamp: serverTimestamp()
      });

      successBox.style.display = 'block';
      form.reset();
    } catch (err) {
      showError(err);
    } finally {
      submitBtn.disabled = false;
      loadingText.style.display = 'none';
    }
  });
</script>
</body>
</html>
