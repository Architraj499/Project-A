<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Account Deletion Request</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  body{
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:#f8fafc;
    margin:0;
    padding:24px
  }
  .card{
    max-width:720px;
    margin:36px auto;
    background:#fff;
    padding:28px;
    border-radius:12px;
    box-shadow:0 6px 30px rgba(2,6,23,0.06)
  }
  h1{font-size:22px;margin:0 0 8px}
  p.lead{color:#374151;margin:0 0 18px}
  label{font-weight:600;color:#111827;margin-top:8px;display:block}
  textarea{
    width:100%;
    min-height:110px;
    padding:10px;
    border:1px solid #e5e7eb;
    border-radius:8px;
    outline:none
  }
  button{
    background:#2563eb;
    color:#fff;
    border:0;
    padding:10px 14px;
    border-radius:8px;
    cursor:pointer
  }
  button[disabled]{opacity:.6;cursor:default}
  .info{
    background:#eef2ff;
    color:#1e3a8a;
    padding:10px;
    border-radius:8px;
    margin-bottom:12px
  }
  .success{
    background:#ecfdf5;
    color:#065f46;
    padding:10px;
    border-radius:8px;
    display:none
  }
  .error{
    background:#fff1f2;
    color:#991b1b;
    border:1px solid #fecaca;
    padding:10px;
    border-radius:8px;
    display:none
  }
  pre{
    background:#0f172a;
    color:#fff;
    padding:10px;
    border-radius:8px;
    overflow:auto;
    white-space:pre-wrap
  }
  a.link{color:#2563eb}
  .small{font-size:13px;color:#6b7280}
</style>
</head>

<body>

<div class="card">
  <h1>Account Deletion Request</h1>
  <p class="lead">Only signed-in users can submit a deletion request.</p>

  <div id="userInfo" class="info">Checking authentication…</div>

  <form id="deleteForm" style="display:none">
    <label for="reason">Reason (optional)</label>
    <textarea id="reason" placeholder="Optional — tell us why..."></textarea>

    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
      <button id="submitBtn" type="submit">Submit Deletion Request</button>
      <span id="loadingText" class="small" style="display:none">Submitting…</span>
    </div>
  </form>

  <div id="success" class="success">✅ Request submitted successfully.</div>

  <div id="errorBox" class="error" style="display:none">
    <div id="errorFriendly"></div>
    <details style="margin-top:8px">
      <summary class="small">Show full error details</summary>
      <pre id="errorDetails"></pre>
    </details>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore,
  collection,
  addDoc,
  serverTimestamp,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ---------- FIREBASE CONFIG ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDHRDRRm2KBmCuUf3qvTIRI5hO0aXFFx3w",
  authDomain: "asprients-95c1f.firebaseapp.com",
  projectId: "asprients-95c1f",
  storageBucket: "asprients-95c1f.appspot.com",
  messagingSenderId: "453218332819",
  appId: "1:453218332819:web:5740173fa4d8156dae9d66"
};
/* ----------------------------------- */

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const userInfo = document.getElementById("userInfo");
const form = document.getElementById("deleteForm");
const submitBtn = document.getElementById("submitBtn");
const loadingText = document.getElementById("loadingText");
const successBox = document.getElementById("success");
const errorBox = document.getElementById("errorBox");
const errorFriendly = document.getElementById("errorFriendly");
const errorDetails = document.getElementById("errorDetails");

let currentFullname = "User";

function clearMessages(){
  successBox.style.display = "none";
  errorBox.style.display = "none";
  errorFriendly.textContent = "";
  errorDetails.textContent = "";
}

function showError(err){
  errorBox.style.display = "block";
  errorFriendly.textContent = err.code || "Unexpected error";
  errorDetails.textContent = err.message || String(err);
  successBox.style.display = "none";
}

/* ---------- AUTH STATE ---------- */
onAuthStateChanged(auth, async (user) => {
  clearMessages();

  if (!user) {
    userInfo.innerHTML = `
      ⚠️ You must be signed in to submit a request.
      <a href="index.html" class="link">Go to login</a>
    `;
    form.style.display = "none";
    return;
  }

  try {
    const snap = await getDoc(doc(db, "users", user.uid));
    if (snap.exists()) {
      currentFullname = snap.data().fullname || "User";
    }
  } catch (err) {
    console.error("Failed to fetch fullname:", err);
  }

  userInfo.innerHTML = `
    <strong>Signed in as:</strong> ${currentFullname} (${user.email})
  `;
  form.style.display = "block";
});

/* ---------- SUBMIT DELETION REQUEST ---------- */
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  clearMessages();

  const user = auth.currentUser;
  if (!user) {
    showError({ code: "unauthenticated", message: "User not logged in." });
    return;
  }

  submitBtn.disabled = true;
  loadingText.style.display = "inline";

  try {
    await addDoc(collection(db, "account_deletion_requests"), {
      name: currentFullname,
      email: user.email,
      userId: user.uid,
      reason: document.getElementById("reason").value.trim(),
      timestamp: serverTimestamp()
    });

    successBox.style.display = "block";
    form.reset();

  } catch (err) {
    showError(err);
  } finally {
    submitBtn.disabled = false;
    loadingText.style.display = "none";
  }
});
</script>

</body>
</html>
